function KoopidEmbed(){this.ts=null,this.providerId=0,this.providerEmail=null,this.deviceType="desktop",this.chattimer=null,this.entryTime=null,this.historyExpiry=3600,this.server=window.location.origin,this.forcepopout=!1,this.retainsession=!1,this.chatting=!1,this.participant=null,this.isbot=!1,this.appinit=!1,this.window_title="",this.window_url="",this.user_context=null,this.entrytag_url=null}function kpde_callit(){var args=Array.prototype.slice.call(arguments,0),value=args.shift();value&&"[object Function]"=={}.toString.call(value)?value.apply(null,args):value&&void 0!==window[value]&&window[value].apply(null,args)}KoopidEmbed.source=document.currentScript&&document.currentScript.src||"",KoopidEmbed.prototype.apiURL=function(path){if(KoopidEmbed.source){var result=KoopidEmbed.source.match("^(.*)(/static/common/js/koopid-embed.js)$");if(result&&result[1])return result[1]+"/api"+path}return this.server+"/KoopidServer/api"+path},KoopidEmbed.prototype.withParams=function(url,params){if(params){var list=[];for(var s in params)list.push(s+(null!==params[s]?"="+encodeURIComponent(params[s]):""));url+=list.length>0?"?"+list.join("&"):""}return url},KoopidEmbed.prototype.withRandom=function(url){return url?url+(url.indexOf("?")>=0?"&":"?")+"r="+(""+Math.random()).substr(2):url},KoopidEmbed.prototype.ajax=function(method,url,data,success_callback,error_callback,options){var response_type,request_type,headers,timeout,nocredentials;options&&(void 0!==options.response_type&&(response_type=options.response_type),void 0!==options.request_type&&(request_type=options.request_type),void 0!==options.headers&&(headers=options.headers),void 0!==options.timeout&&(timeout=options.timeout),!1===options.withCredentials&&(nocredentials=!0)),void 0===timeout&&(timeout=1e4);var request=new XMLHttpRequest;if(void 0!==success_callback||void 0!==error_callback){var timer=null;timeout&&timeout>0&&(timer=setTimeout(function(){4!=request.readyState&&(request.abort(),kpde_callit(error_callback,"408 Request Timeout"))},timeout)),request.onreadystatechange=function(){if(4==request.readyState)if(null!=timer&&(clearTimeout(timer),timer=null),request.status>=200&&request.status<300){if(void 0!==response_type)return console.log("koopid-embed.js: ajax - response received"),void kpde_callit(success_callback,request.response);console.log("koopid-embed.js: ajax - response "+(request.responseText&&request.responseText.substr(0,100)));var response={};try{request.responseText&&(response=JSON.parse(request.responseText))}catch(e){return console.log("koopid-embed.js: ajax - error parsing response as JSON: "+e+"\nresponseText="+request.responseText),void kpde_callit(error_callback,"failed to parse response")}response.error?kpde_callit(error_callback,response.error.info||"received error"):kpde_callit(success_callback,response)}else{var status="N/A",statusText="N/A";try{status=request.status}catch(e){}try{statusText=request.statusText}catch(e){}if(0==status&&!statusText){var hostname=url.match(/^https?:\/\/([^\/]+)/im);status="",statusText="failed "+(hostname&&hostname[1]||url)}kpde_callit(error_callback,status+" "+statusText)}}}if(response_type&&("xml"==response_type?(request.response_type="document",request.overrideMimeType("text/xml")):request.responseType=response_type),request.open(method,url,!0),nocredentials||(request.withCredentials=!0),response_type&&"json"==response_type&&request.setRequestHeader("Accept","application/json"),headers&&headers.length>0&&headers.length%2==0)for(var i=0;i<headers.length;i+=2)request.setRequestHeader(headers[i],headers[i+1]);return data?request_type&&"application/json"!=request_type?"ignore"!=request_type&&request.setRequestHeader("Content-Type",request_type):(request.setRequestHeader("Content-Type","application/json"),data=JSON.stringify(data),console.log("koopid-embed.js: ajax - request "+url.substr(0,100)+"\n"+data.substr(0,100))):console.log("koopid-embed.js: ajax - request "+url.substr(0,100)),request.send("GET"==method?null:data||""),request},KoopidEmbed.prototype.store=function(name,value){if(void 0!==value&&null!==value)try{localStorage["koopid."+name]=JSON.stringify(value)}catch(e){alert("localStorage failed")}else try{delete localStorage["koopid."+name]}catch(e){}},KoopidEmbed.prototype.load=function(name){return JSON.parse(localStorage["koopid."+name]||"null")},KoopidEmbed.prototype.trackUrl=function(){var url=window.location.href,title=document.title,duration=Math.round((new Date).getTime()/1e3-this.entryTime);console.log("koopid-embed.js: Adding History for "+url+" with Title "+title+" Duration "+duration),this.addUrlHistory(url,title,duration,this.providerEmail),console.log("koopid-embed.js: "+JSON.stringify(this.getUrlHistory()))},KoopidEmbed.prototype.getUrlHistory=function(){return this.load("url_tracker")},KoopidEmbed.prototype.getUrlHistoryIndexForProvider=function(historyArray,providerEmail){for(let i=0;i<historyArray.length;i++){var history=historyArray[i];if(null!=history.provider&&history.provider==providerEmail)return i}return-1},KoopidEmbed.prototype.addUrlHistory=function(url,title,duration,providerEmail){var foundUrl=!1,indexProv=-1,currTime=Math.round((new Date).getTime()/1e3),historyArray=this.getUrlHistory();if(historyArray||(historyArray=new Array),(indexProv=this.getUrlHistoryIndexForProvider(historyArray,providerEmail))<0)historyArray.push({type:"url-history",provider:providerEmail,context:[{URL:url,title:title,duration:[duration],count:1,lastTime:currTime}]});else{var this_=this;historyArray[indexProv].context.forEach(function(item){item.lastTime+this_.historyExpiry<currTime&&(console.log("koopid-embed.js: Cleaning up old entries in URL tracker"),item.duration=[],item.count=item.lastTime=0),item.URL==url&&(foundUrl=!0,item.duration.push(duration),item.count+=1,item.lastTime=currTime)}),foundUrl||historyArray[indexProv].context.push({URL:url,title:title,duration:[duration],count:1,lastTime:currTime})}this.store("url_tracker",historyArray)},KoopidEmbed.prototype.storeUrlHistoryForProvider=function(providerEmail,provId){var historyArray=this.getUrlHistory();historyArray?(indexProv=this.getUrlHistoryIndexForProvider(historyArray,providerEmail),-1!=indexProv?(console.log("koopid-embed.js: Storing URL History for Provider "+provId+" History "+JSON.stringify(historyArray[indexProv])),this.store("url_tracker_"+provId,historyArray[indexProv])):console.log("koopid-embed.js: No URL history to store for provider "+providerEmail)):console.log("koopid-embed.js: No URL history to store for provider "+providerEmail)},KoopidEmbed.prototype.sendSMS=function(phone,body,success_callback,error_callback){var u=this.apiURL("/SMS"),data1={to:phone,body:body};this.ajax("POST",u,data1,function(response){kpde_callit(success_callback,response)},function(error){kpde_callit(error_callback,error)})},KoopidEmbed.prototype.sendEmail=function(subject,body,recipient,success_callback,error_callback){var u=this.apiURL("/Email"),data1={to:recipient,from:"support@koopid.io",subject:subject,body:body};this.ajax("POST",u,data1,function(response){kpde_callit(success_callback,response)},function(error){kpde_callit(error_callback,error)})},KoopidEmbed.prototype.getLang=function(){return void 0!=navigator.languages?navigator.languages[0]:void 0!=navigator.language?navigator.language:void 0!=navigator.browserLanguage?navigator.browserLanguage:null};var kpde_isMobile_Android=function(){return navigator.userAgent.match(/Android/i)},kpde_isMobile_iOS=function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)};KoopidEmbed.prototype.getDeviceType=function(){return kpde_isMobile_Android()?"Android":kpde_isMobile_iOS()?"iOS":"web"},KoopidEmbed.prototype.getEntryTagUrl=function(providerId,tag,msg,success_callback,error_callback){var this_=this,etu=this.apiURL("/Customization/EntryTag/"+providerId+"/"+tag);etu=this.withParams(etu,{device:this.getDeviceType()}),this.ajax("GET",etu,null,function(value){if("success"==value.code){var url=this_.server+value.entity.url;msg&&(url+="&send="+msg),this_.providerId=value.entity.providerId,kpde_callit(success_callback,url)}else kpde_callit(error_callback,value.reason)},error_callback)},KoopidEmbed.prototype.getProvider=function(email,success_callback,error_callback){var etu=this.apiURL("/Provider"),data={filter:{email:email},deep:2};etu=this.withParams(etu,{data:JSON.stringify(data)}),o.ajax("GET",etu,null,function(value){kpde_callit(success_callback,value.entity[0])},error_callback)},KoopidEmbed.prototype.initEntryTags=function(){for(var elements=document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag"),i=0;elements&&i<elements.length;++i)this.initKoopidTag(elements[i]);for(elements=document.querySelectorAll("#kpd_smstag, .kpd_smstag"),i=0;elements&&i<elements.length;++i)this.initSmsTag(elements[i]);for(elements=document.querySelectorAll("#kpd_emailtag, .kpd_emailtag"),i=0;elements&&i<elements.length;++i)this.initEmailTag(elements[i])},KoopidEmbed.prototype.initKoopidTag=function(element){var enableproactivechat="true"==element.getAttribute("data-kpdproactive"),chattimeout=1e4;if(enableproactivechat){var chattimer=1e3*parseInt(element.getAttribute("data-kpdproactivetimer")||"");isNaN(chattimer)||(chattimeout=chattimer)}this.retainsession="true"==element.getAttribute("data-retainsession"),this.forcepopout="true"==element.getAttribute("data-forcepopout"),this.forcepopout&&(this.retainsession=!1);var this_=this;element.addEventListener("click",function(){var providerEmail=this.getAttribute("data-kpdprovemail")||this_.providerEmail,tag=this.getAttribute("data-kpdtag"),msg=this.getAttribute("data-kpdmsg"),params=this.getAttribute("data-kpdparams"),scb=this.getAttribute("data-kpdsuccesscb"),ecb=this.getAttribute("data-kpderrorcb"),embedded="true"==this.getAttribute("data-kpdembedded"),guest="true"==this.getAttribute("data-kpdguest");if(this_.forcepopout="true"==this.getAttribute("data-kpdforcepopout"),this_.retainsession="true"==this.getAttribute("data-retainsession"),this_.storeUrlHistoryForProvider(providerEmail,this_.providerId),params&&"?"==params.substr(0,1)){let tagurl=this_.server+"/kpd-client/index.html"+params;return this_.onChatClick(tagurl,!0,embedded),this_.retainsession&&(this_.store("entrytag_url",tagurl),scb&&this_.store("scb",scb)),void kpde_callit(scb)}this_.getEntryTagUrl(providerEmail,tag,msg,function(tagurl){guest&&(tagurl+="&username=guest&password=guest"),params&&(tagurl+=("&"==params.substr(0,1)?"":"&")+params),tagurl+="&provider="+this_.providerId,this_.retainsession&&(tagurl+="&retainsession=true"),this_.onChatClick(tagurl,!1,embedded),this_.retainsession&&(this_.store("entrytag_url",tagurl),scb&&this_.store("scb",scb)),kpde_callit(scb)},ecb)}),enableproactivechat&&(this.chattimer=setTimeout(function(){this_.chattimer=null,"false"==document.getElementById("kpd_chat").getAttribute("enabled")&&element.click()},chattimeout))},KoopidEmbed.prototype.initSmsTag=function(element){var this_=this;element.addEventListener("click",function(){var providerEmail=this.getAttribute("data-kpdprovemail")||this_.providerEmail,tag=this.getAttribute("data-kpdtag"),msg=this.getAttribute("data-kpdmsg"),phone=this.getAttribute("data-kpdphone");if(phone||(phone=prompt("Please enter the phone number","1xxxyyyyyyy")),phone&&"1xxxyyyyyyy"!=phone){var scb=this.getAttribute("data-kpdsuccesscb"),ecb=this.getAttribute("data-kpderrorcb");this_.getEntryTagUrl(providerEmail,tag,msg,function(url){var body="Please click to Launch Koopid "+encodeURIComponent(url);this_.sendSMS(phone,body,scb,ecb)},function(error){console.log("koopid-embed.js: Get entry tag failed for send SMS"+error),kpde_callit(ecb,error)})}})},KoopidEmbed.prototype.initEmailTag=function(element){var this_=this;element.addEventListener("click",function(){var providerEmail=this.getAttribute("data-kpdprovemail")||this_.providerEmail,tag=this.getAttribute("data-kpdtag"),email=this.getAttribute("data-kpdcustemail");if(email||(email=prompt("Please enter the Email address","user@domain")),email&&"user@domain"!=email){var scb=this.getAttribute("data-kpdsuccesscb"),ecb=this.getAttribute("data-kpderrorcb"),templateUrl=this.getAttribute("data-kpdtemplateurl"),subject=this.getAttribute("data-kpdemailsubject"),msg=this.getAttribute("data-kpdmsg");this_.ajax("GET",templateUrl,null,function(template){console.log("koopid-embed.js: get email template - success"),this_.getEntryTagUrl(providerEmail,tag,msg,function(tagUrl){var body=template.replace(/%%%CONTEXT%%%/,tagUrl);this_.sendEmail(subject,body,email,scb,ecb)},function(error){console.log("koopid-embed.js: sendEmail - get entry tag - "+error),kpde_callit(ecb,error)})},function(error){console.log("koopid-embed.js: sendEmail - get email template - "+error),kpde_callit(ecb,error)},{response_type:"html"})}})},KoopidEmbed.prototype.createSendParam=function(data,text,type){return void 0===text&&(text="assign"),void 0===type&&(type="hidden"),encodeURIComponent(JSON.stringify({type:type||"hidden",text:text||void 0,data:data||void 0}))},KoopidEmbed.prototype.createKpdChat=function(){var chatdiv=document.createElement("div");chatdiv.id="kpd_chat",chatdiv.setAttribute("enabled",!1);var minimize=document.createElement("div");minimize.className="kpd_button kpd_minimize",chatdiv.appendChild(minimize),minimize.addEventListener("click",function(event){chatdiv.setAttribute("enabled","true"==chatdiv.getAttribute("enabled")?"minimized":"true")}),document.getElementsByTagName("body")[0].appendChild(chatdiv);let this_=this;window.addEventListener("message",function(event){var kpd_chat=document.getElementById("kpd_chat"),iframe=kpd_chat.querySelector("iframe");if(console.log("Received message from client "+("string"==typeof event.data?event.data:JSON.stringify(event.data))),iframe&&iframe.src&&iframe.src.substr(0,event.origin.length)==event.origin){var data="string"==typeof event.data?JSON.parse(event.data):event.data;if("close"==data.type||"chat-closed"==data.type)iframe=document.getElementById("kpd_chat").querySelector("iframe"),document.getElementById("kpd_chat").setAttribute("enabled","false"),setTimeout(function(){iframe.onload=function(){},iframe.src="about:blank",iframe.id="",setTimeout(function(){document.getElementById("kpd_chat").removeChild(iframe)},500)},1e3);else if("minimize"==data.type)kpd_chat.querySelector(".kpd_button.kpd_minimize").click();else if("appinit"==data.type)this_.on_chat_loaded();else if("chatstart"==data.type){try{this_.store("chatting",""+data.id),this_.store("participant",""+data.participant)}catch(e){}this_.isbot&&this_.on_send_history()}else"send-history"==data.type?this_.on_send_history(!0):"close"!=data.type&&"chat-closed"!=data.type&&"chatstop"!=data.type||(this_.chatting=!1,this_.isbot=!1,this_.on_chat_closed())}else win&&!win.closed&&win.close();console.log("koopid-embed.js: received event"),console.log(event)})},KoopidEmbed.prototype.onChatClick=function(url,nochange,embedded){this.chattimer&&(clearTimeout(this.chattimer),this.chattimer=null);var iframe;window.location;(nochange||(url+="&autoconfig=true",url+="&trackhistory=true"),embedded)?"false"==document.getElementById("kpd_chat").getAttribute("enabled")?((iframe=document.getElementById("kpd_chat").querySelector("iframe"))&&(iframe.onload=function(){},iframe.src="about:blank",iframe.id="",document.getElementById("kpd_chat").removeChild(iframe)),(iframe=document.createElement("iframe")).id="kpd_iframe",iframe.src=url,iframe.setAttribute("frameborder","0"),iframe.setAttribute("allow","geolocation *; camera *; microphone *"),iframe.onload=function(){console.log("koopid-embed.js: iframe loaded"),setTimeout(function(){document.getElementById("kpd_chat").setAttribute("enabled","true"),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(iframe.setAttribute("style","width: 1px; height: 1px;"),setTimeout(function(){iframe.setAttribute("style","min-width: 100%; min-height: 100%;")},1e3))},500)},document.getElementById("kpd_chat").appendChild(iframe)):"minimized"==document.getElementById("kpd_chat").getAttribute("enabled")?document.getElementById("kpd_chat").setAttribute("enabled","true"):(iframe=document.getElementById("kpd_chat").querySelector("iframe"),document.getElementById("kpd_chat").setAttribute("enabled","false"),setTimeout(function(){iframe.onload=function(){},iframe.src="about:blank",iframe.id="",document.getElementById("kpd_chat").removeChild(iframe)},500)):this.launchClient(url)};var win=void 0;KoopidEmbed.prototype.launchClient=function(url_or_params){var url1,url2;if("object"==typeof url_or_params?void 0===url_or_params.resize?(url_or_params.resize="fit",url1=this.withParams("/kpd-client/index.html",url_or_params),url_or_params.resize="auto",url2=this.withParams("/kpd-client/index.html",url_or_params)):url1=url2=this.withParams("/kpd-client/index.html",url_or_params):url_or_params.search(/[&\?]resize=/)<0?(url1=url_or_params.replace(/\?/,"?resize=fit&"),url2=url_or_params.replace(/\?/,"?resize=auto&")):url1=url2=url_or_params,console.log("Launching popout window on user agent: "+navigator.userAgent),void 0===win||win.closed)if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&this.forcepopout){console.log("Using iOS hack to force open the window");var kpdpopout=document.getElementById("kpd_chat").querySelector("#kpd_popout");void 0==kpdpopout&&((kpdpopout=document.createElement("a")).setAttribute("id","kpd_popout"),document.getElementById("kpd_chat").appendChild(kpdpopout),kpdpopout.setAttribute("href",url1),kpdpopout.setAttribute("style","position: absolute;top: 0;display: none"),kpdpopout.setAttribute("target","_blank")),kpdpopout.click()}else console.log("Using window.open for the popout window"),(win=window.open(url1,"_blank","width=420,height=640,location=no,resizable=no,menubar=no"))?win.focus():(console.log("could not open the popup window."),window.location.href=url2);else win.focus()},KoopidEmbed.prototype.initialize=function(providerEmail){if(this.entryTime)throw"koopid-embed.js: Koopid System is already initialized for provider "+this.providerEmail;if(this.providerEmail=providerEmail||document.body.getAttribute("provider-email")||null,!this.providerEmail){console.log("koopid-embed.js: missing provider email.  Checking all elements");var kpdelm=document.querySelector("[data-kpdprovemail]");kpdelm&&(this.providerEmail=kpdelm.getAttribute("data-kpdprovemail")||null),this.providerEmail||console.warn('koopid-embed.js: missing provider email during initialize, use <body provider-email="info@provider.domain">')}this.providerEmail&&console.log("koopid-embed.js: Initializing koopid system with "+this.providerEmail);try{if(this.chatting=this.load("chatting")||!1,this.participant=this.load("participant")||!1,"null"==this.participant&&(this.participant=null),this.isbot="true"==this.load("isbot"),this.entrytag_url=this.load("entrytag_url")||null,this.entrytag_url=this.entrytag_url&&"undefined"==this.entrytag_url?void 0:this.entrytag_url,this.user_context=this.getUserContext(),console.log("koopid-embed.js: chatting: "+this.chatting+", participant: "+this.participant+", isbot: "+this.isbot),this.chatting&&this.entrytag_url){var this_=this;setTimeout(function(){let kpd_chat=document.querySelector("div#kpd_chat");kpd_chat&&(kpd_chat.style.visibility="hidden"),this_.start_chat(this_.chatting,this_.entrytag_url)},500)}else console.log("koopid-embed.js: no saved entrytag_url.  Click on the button to start a new session")}catch(e){console.log("koopid-embed.js: No ongoing chat sessions.  Click on the button to start a new session")}this.initEntryTags(),this.createKpdChat(),this.entryTime=(new Date).getTime()/1e3;this_=this;window.addEventListener("beforeunload",function(event){console.log("koopid-embed.js: Before unloading"),this_.trackUrl()})},KoopidEmbed.prototype.initializeProvider=function(providerEmail){return this.initialize(providerEmail)};var kpde=new KoopidEmbed;window.onload=function(){kpde.initialize()},KoopidEmbed.prototype.start_chat=function(chatting,entrytag_url){var url=entrytag_url;if(url=(url+="&loadscreen=true").replace(/&target=(.*?)&/,"&target=chat/"+this.chatting+"&"),!this.participant)return console.log("Session stickiness: Participant si not present in localstore.  Clearing residual data."),void this.on_chat_closed();url=(url=url.replace(/&username=(guest)/,"&username="+encodeURIComponent(this.participant))).replace(/send=(.*?)&/,""),console.log("Session Stickiness URL: "+url),null!=this.user_context?(console.log("Adding user_context "+this.user_context),url=url+"&ooredoo-context="+encodeURIComponent(this.user_context)):console.log("User context not defined"),this.onChatClick(url,!0,!0),this.load("scb")&&kpde_callit(this.load("scb"))},KoopidEmbed.prototype.on_chat_loaded=function(){var div=document.querySelector("div#kpd_chat");div.setAttribute("enabled","true"),div.style.visibility="visible"},KoopidEmbed.prototype.on_chat_started=function(chat_id,participant_email){this.chatting=chat_id,this.participant=participant_email;try{this.store("chatting",""+this.chat_id),this.store("participant",""+this.participant)}catch(e){}this.isbot&&on_send_history()},KoopidEmbed.prototype.on_chat_closed=function(event){console.log("on_chat_closed: clearing all house keeping data for session stickiness");try{this.store("chatting")}catch(e){console.log("Unable to clear koopid.chatting")}try{this.store("participant")}catch(e){console.log("Unable to clear koopid.participlant")}try{this.store("isbot")}catch(e){console.log("Unable to clear koopid.isbot")}try{this.store("entrytag_url")}catch(e){console.log("Unable to clear stored entrytag URL")}try{this.store("scb")}catch(e){console.log("Unable to clear koopid.scb")}var div=document.querySelector("div#kpd_chat");div.setAttribute("enabled","false"),div.style.visibility=""},KoopidEmbed.prototype.getUserContext=function(){var context=this.load("usercontext");return"null"==context||void 0==context?null:context};